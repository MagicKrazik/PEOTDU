{% extends "base.html" %}
{% load static %}

{% block title %}PEOTDU - BCS - Visualiza la cartografia{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<link rel="stylesheet" href="{% static 'css/mapa.css' %}">
{% endblock %}

{% block content %}
<div class="map-container">
    <h1><i class="fas fa-map-marked-alt"></i> Visualiza la cartografia</h1>
    <div class="gradient-line"></div>
    <div id="map-container">
        <div id="map"></div>
        <button id="toggle-panel" class="control-button">
            <i class="fas fa-chevron-left"></i>
        </button>
        <div id="control-panel">
            <h3><i class="fas fa-layer-group"></i> Capas</h3>
            <div id="kml-list"></div>
            <h3><i class="fas fa-globe"></i> Tipo de Mapa</h3>
            <select id="map-type">
                <option value="satellite">Vista Satélite</option>
                <option value="street">Vista de Calle</option>
            </select>
        </div>
    </div>
    <div class="gradient-line-bottom"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var map, osmLayer, satelliteLayer;
    var kmlLayers = {};

    function initMap() {
        osmLayer = new ol.layer.Tile({
            source: new ol.source.OSM(),
            visible: false
        });

        satelliteLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                maxZoom: 19
            }),
            visible: true
        });

        map = new ol.Map({
            target: 'map',
            layers: [osmLayer, satelliteLayer],
            view: new ol.View({
                center: ol.proj.fromLonLat([-112.0, 26.0]), // Centered on Baja California Sur
                zoom: 7
            })
        });

        loadKMLLayers();
        setupMapTypeControl();
        setupTogglePanel();
    }

    function loadKMLLayers() {
        var kmlFiles = [
            { name: 'Subregiones', path: '{% static "kml/Subregiones.kml" %}', icon: 'fa-border-all' },
            { name: 'Sistema de Ciudades', path: '{% static "kml/Sistema_de_Ciudades.kml" %}', icon: 'fa-building' },
            { name: 'Regionalización', path: '{% static "kml/Regionalizacion.kml" %}', icon: 'fa-map-signs' },
            { name: 'Proyectos Estratégicos', path: '{% static "kml/Proyectos_Estrategicos.kml" %}', icon: 'fa-plus' },
            { name: 'Enlaces de movilidad', path: '{% static "kml/Propuesta_de_Sistema_de_Enlaces_de_Movilidad.kml" %}', icon: 'fa-paper-plane' },
            { name: 'Mapa Base', path: '{% static "kml/Mapa_Base.kml" %}', icon: 'fa-map' },
            { name: 'Centros de Población', path: '{% static "kml/Centros_de_Poblacion.kml" %}', icon: 'fa-location-arrow' },
        ];

        var kmlListDiv = document.getElementById('kml-list');

        kmlFiles.forEach(function(kmlFile, index) {
            var layer = new ol.layer.Vector({
                source: new ol.source.Vector({
                    url: kmlFile.path,
                    format: new ol.format.KML({
                        extractStyles: true,
                        extractAttributes: true
                    })
                }),
                visible: false
            });

            map.addLayer(layer);
            kmlLayers['layer' + index] = layer;

            var div = document.createElement('div');
            div.className = 'kml-item';
            
            var checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = 'layer' + index;
            checkbox.addEventListener('change', function() {
                layer.setVisible(this.checked);
            });

            var label = document.createElement('label');
            label.htmlFor = 'layer' + index;
            label.innerHTML = `<i class="fas ${kmlFile.icon}"></i> ${kmlFile.name}`;

            div.appendChild(checkbox);
            div.appendChild(label);

            kmlListDiv.appendChild(div);
        });
    }

    function setupMapTypeControl() {
        var mapTypeSelect = document.getElementById('map-type');
        mapTypeSelect.addEventListener('change', function() {
            if (this.value === 'street') {
                osmLayer.setVisible(true);
                satelliteLayer.setVisible(false);
            } else {
                osmLayer.setVisible(false);
                satelliteLayer.setVisible(true);
            }
        });
    }

    function setupTogglePanel() {
        var toggleButton = document.getElementById('toggle-panel');
        var controlPanel = document.getElementById('control-panel');
        toggleButton.addEventListener('click', function() {
            controlPanel.classList.toggle('hidden');
            this.classList.toggle('active');
            if (this.classList.contains('active')) {
                this.innerHTML = '<i class="fas fa-chevron-right"></i>';
            } else {
                this.innerHTML = '<i class="fas fa-chevron-left"></i>';
            }
        });
    }

    initMap();
});
</script>
{% endblock %}